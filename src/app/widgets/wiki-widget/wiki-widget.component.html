<div class="wiki-widget">
  <div class="wiki-header">
    <button mat-button (click)="openExistingWiki()">Open Wiki</button>
    <button mat-button (click)="createNewWiki()">New Wiki</button>
    <button mat-button (click)="importWikiZip()" matTooltip="Import from ZIP archive">
      <mat-icon>upload</mat-icon> Import
    </button>
    <button mat-button (click)="exportWikiZip()" [disabled]="wikiData.articles.length === 0" matTooltip="Export to ZIP archive with images">
      <mat-icon>download</mat-icon> Export
    </button>
    <span *ngIf="fileName" class="file-info" [class.has-error]="saveError" [class.is-stale]="isSaveStale() && !saveError">
      <span class="file-name">{{ fileName }}</span>
      <span *ngIf="saveError" class="save-error-indicator">
        <mat-icon>error</mat-icon> NOT SAVING
      </span>
      <span *ngIf="!saveError && hasUnsavedChanges && !isSaving" class="unsaved-indicator">
        <mat-icon>edit</mat-icon> unsaved
      </span>
      <span *ngIf="!saveError && lastSavedToFile && !hasUnsavedChanges" class="last-saved" [class.stale]="isSaveStale()">
        <mat-icon>{{ isSaveStale() ? 'warning' : 'check_circle' }}</mat-icon>
        saved {{ getLastSavedText() }}
      </span>
    </span>
  </div>

  <!-- Loading/error indicators -->
  <div *ngIf="isSaving" class="save-indicator">Saving...</div>
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

  <div class="wiki-body" *ngIf="fileHandle || wikiData.articles.length">
    <div class="wiki-sidebar" [class.collapsed]="sidebarCollapsed">
      <div class="sidebar-toggle">
        <button mat-icon-button (click)="toggleSidebar()">
          <mat-icon>{{ sidebarCollapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
        </button>
      </div>
      <div class="sidebar-content" [class.hidden]="sidebarCollapsed">
        <div class="sidebar-header">
          <h3>Articles</h3>
        </div>
        <!-- Button to add a root article -->
        <button mat-mini-fab color="primary" (click)="addArticle()">+</button>
        <input
          type="text"
          placeholder="Search articles..."
          [(ngModel)]="searchTerm"
          class="search-input"
        />
        <!-- Use virtual scrolling for better performance with large article lists -->
        <cdk-virtual-scroll-viewport itemSize="36" class="article-viewport">
          <ul>
            <ng-container *ngFor="let article of filteredArticles; trackBy: trackByArticleId">
              <ng-container *ngTemplateOutlet="recursiveList; context:{ article: article, level: 0 }"></ng-container>
            </ng-container>
          </ul>
        </cdk-virtual-scroll-viewport>
      </div>
    </div>
    <div class="wiki-content">
      <div *ngIf="currentArticle" class="article-container">
        <div class="article-header">
          <input
            type="text"
            [(ngModel)]="currentArticle.title"
            (ngModelChange)="updateArticle()"
            placeholder="Article Title"
            class="title-input"
          >
        </div>

        <!-- Editor Toolbar -->
        <div *ngIf="currentArticle" class="editor-toolbar">
          <button mat-icon-button (click)="toggleBold()" [class.active]="editor?.isActive('bold')" matTooltip="Bold">
            <mat-icon>format_bold</mat-icon>
          </button>
          <button mat-icon-button (click)="toggleItalic()" [class.active]="editor?.isActive('italic')" matTooltip="Italic">
            <mat-icon>format_italic</mat-icon>
          </button>
          <div class="toolbar-divider"></div>
          <button mat-icon-button (click)="toggleHeading(1)" [class.active]="editor?.isActive('heading', { level: 1 })" matTooltip="Heading 1">
            <mat-icon>title</mat-icon>
          </button>
          <button mat-icon-button (click)="toggleHeading(2)" [class.active]="editor?.isActive('heading', { level: 2 })" matTooltip="Heading 2">
            <span class="heading-label">H2</span>
          </button>
          <button mat-icon-button (click)="toggleHeading(3)" [class.active]="editor?.isActive('heading', { level: 3 })" matTooltip="Heading 3">
            <span class="heading-label">H3</span>
          </button>
          <div class="toolbar-divider"></div>
          <button mat-icon-button (click)="toggleBulletList()" [class.active]="editor?.isActive('bulletList')" matTooltip="Bullet List">
            <mat-icon>format_list_bulleted</mat-icon>
          </button>
          <button mat-icon-button (click)="toggleOrderedList()" [class.active]="editor?.isActive('orderedList')" matTooltip="Numbered List">
            <mat-icon>format_list_numbered</mat-icon>
          </button>
          <div class="toolbar-divider"></div>
          <button mat-icon-button (click)="toggleBlockquote()" [class.active]="editor?.isActive('blockquote')" matTooltip="Blockquote">
            <mat-icon>format_quote</mat-icon>
          </button>
          <button mat-icon-button (click)="toggleCodeBlock()" [class.active]="editor?.isActive('codeBlock')" matTooltip="Code Block">
            <mat-icon>code</mat-icon>
          </button>
          <div class="toolbar-divider"></div>
          <button mat-icon-button (click)="insertWikiLink()" matTooltip="Insert Wiki Link">
            <mat-icon>link</mat-icon>
          </button>
          <button mat-icon-button (click)="insertImage()" matTooltip="Insert Image">
            <mat-icon>image</mat-icon>
          </button>
          <div class="toolbar-divider"></div>
          <button mat-icon-button (click)="insertTable()" matTooltip="Insert Table">
            <mat-icon>table_chart</mat-icon>
          </button>
          <button mat-icon-button (click)="addColumnBefore()" matTooltip="Add Column Before" [disabled]="!canAddColumnBefore()">
            <mat-icon>first_page</mat-icon>
          </button>
          <button mat-icon-button (click)="addColumnAfter()" matTooltip="Add Column After" [disabled]="!canAddColumnAfter()">
            <mat-icon>last_page</mat-icon>
          </button>
          <button mat-icon-button (click)="addRowBefore()" matTooltip="Add Row Before" [disabled]="!canAddRowBefore()">
            <mat-icon>vertical_align_top</mat-icon>
          </button>
          <button mat-icon-button (click)="addRowAfter()" matTooltip="Add Row After" [disabled]="!canAddRowAfter()">
            <mat-icon>vertical_align_bottom</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteColumn()" matTooltip="Delete Column" [disabled]="!canDeleteColumn()">
            <mat-icon>view_week</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteRow()" matTooltip="Delete Row" [disabled]="!canDeleteRow()">
            <mat-icon>view_day</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteTable()" matTooltip="Delete Table" [disabled]="!canDeleteTable()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <!-- TipTap Editor Container -->
        <div class="editor-container">
          <div #editorContainer class="tiptap-editor"></div>
        </div>
      </div>
      <div *ngIf="!currentArticle" class="empty-state">
        <p>No article selected. Add an article from the sidebar.</p>
      </div>
    </div>
  </div>
  <div *ngIf="!fileHandle && wikiData.articles.length === 0" class="empty-wiki">
    <p>No wiki loaded. Open an existing wiki or create a new one.</p>
  </div>
</div>

<!-- Recursive template for hierarchical display -->
<ng-template #recursiveList let-article="article" let-level="level">
  <li [style.paddingLeft.px]="level * 16" [class.active]="article.id === currentArticle?.id" (click)="selectArticle(article)">
    <span>{{ article.title }}</span>
    <button mat-icon-button color="warn" (click)="deleteArticle(article, $event)">
      <mat-icon>delete</mat-icon>
    </button>
    <button mat-icon-button color="primary" (click)="addSubArticle(article, $event)">
      <mat-icon>add</mat-icon>
    </button>
  </li>
  <ng-container *ngIf="article.children && article.children.length">
    <ng-container *ngFor="let child of article.children; trackBy: trackByArticleId">
      <ng-container *ngTemplateOutlet="recursiveList; context:{ article: child, level: level + 1 }"></ng-container>
    </ng-container>
  </ng-container>
</ng-template>
